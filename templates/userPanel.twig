{% extends "base.twig" %}

{% block title %}Obituario de mascotas{% endblock %}
{% block head %}
    {{ parent() }}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="mb-4">
            {% if message %}
                <div class="alert alert-warning text-center" role="alert">
                    {{ message }}
                </div>
            {% endif %}

            <h5>Tus mascotas</h5>
            <div id="pet-list" class="border p-3 rounded bg-light">
                {% if pets is not empty %}
                    <ul class="list-group">
                        <ol class="list-group list-group-numbered">
                            {% for pet in pets %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div class="fw-bold">{{ pet.name }}</div>
                                            <span>{{ pet.breed|e }} {{ pet.type|e }}</span> //poner bonito
                                        </div>
                                        <span class="badge text-bg-primary rounded-pill">14</span>
                                    </li>
                            {% endfor %}
                        </ol>
                    </ul>



                {% else %}
                    <p class="text-muted">No has añadido ninguna mascota todavía.</p>
                {% endif %}
            </div>
        </div>
        <button id="add-pet-form-btn" class="btn btn-secondary rounded-pill py-2 px-4 mb-3">+ Añadir mascota</button>

        <div class="card p-4 border rounded shadow-sm bg-white d-none" id="pet-form-container">
            <div id="form-alert" class="alert alert-danger d-none" role="alert"></div>
            <h3 class="mb-4">Añadir mascota al obituario</h3>

            <form id="obituary-form" method="POST" enctype="multipart/form-data" action="/tribute/add" autocomplete="off">
                <div class="row g-3">

                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" name="name" id="name" class="form-control" placeholder="Nombre" maxlength="100" required pattern="[^<>]+" oninput="this.value=this.value.replace(/[<>]/g,'')">
                            <label for="name">Nombre del animal *</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-floating">
                            <select name="petType" id="petType" class="form-select form-select-sm" required>
                                <option disabled selected>Selecciona tipo</option>
                                <option value="perro">Perro</option>
                                <option value="gato">Gato</option>
                                <option value="otro">Otro</option>
                            </select>
                            <label for="type">Tipo de mascota *</label>
                        </div>
                    </div>

                    <div class="col-md-6 d-none" id="custom-type-container">
                        <div class="form-floating">
                            <input type="text" name="customType" id="customType" class="form-control" placeholder="Tipo de mascota" maxlength="100" pattern="[^<>]+" oninput="this.value=this.value.replace(/[<>]/g,'')">
                            <label for="customType">Especifica el tipo</label>
                        </div>
                    </div>

                    <div class="col-md-4" id="breed-container">
                        <div class="form-floating">
                            <select name="breed" id="breed" class="form-select" required>
                                <option disabled selected>Selecciona raza</option>
                            </select>
                            <label for="breed">Raza *</label>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="mixedBreed" name="mixedBreed">
                            <label class="form-check-label" for="mixedBreed">
                                ¿Es cruce? <span class="text-muted small">(Ej: cruce de pastor alemán)</span>
                            </label>
                        </div>
                        <div class="form-floating mt-2 d-none" id="custom-breed-container">
                            <input type="text" name="customBreed" id="customBreed" class="form-control" placeholder="Introduce la raza" maxlength="100" pattern="[^<>]+" oninput="this.value=this.value.replace(/[<>]/g,'')">
                            <label for="custom-breed">Introduce la raza</label>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="form-floating">
                            <input type="date" name="birthDate" id="birthDate" class="form-control" required>
                            <label for="birthDate">Nacimiento *</label>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="form-floating">
                            <input type="date" name="deathDate" id="deathDate" class="form-control" required>
                            <label for="deathDate">Fallecimiento *</label>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-floating">
                            <textarea name="biography" id="biography" class="form-control" style="height: 100px" maxlength="255" pattern="[^<>]+" oninput="this.value=this.value.replace(/[<>]/g,'')"></textarea>
                            <label for="biography">Biografía</label>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-floating">
                            <textarea name="farewell" id="farewell" class="form-control" style="height: 100px" maxlength="255" pattern="[^<>]+" oninput="this.value=this.value.replace(/[<>]/g,'')"></textarea>
                            <label for="farewell">Mensaje de despedida</label>
                        </div>
                    </div>

                    <div class="col-6">
                        <label for="photo" class="form-label">Foto del animal</label>
                        <input type="file" name="photo" id="photo" class="form-control" accept="image/jpeg,image/png,image/webp">
                        <small class="text-muted">Formatos permitidos: JPG, PNG, WEBP. Solo imágenes del animal, contenido inapropiado será eliminado.</small>
                    </div>

                    <div class="col-12 mt-3">
                        <button type="submit" class="btn btn-success rounded-pill px-5 py-2" aria-label="Guardar obituario de mascota">Guardar obituario</button>
                    </div>

                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        document.getElementById('add-pet-form-btn').addEventListener('click', function () {
            const formContainer = document.getElementById('pet-form-container');
            formContainer.classList.toggle('d-none');
        });

        document.getElementById('photo').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Solo se permiten imágenes JPG, PNG o WEBP.');
                event.target.value = '';
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('La imagen no debe superar los 5MB.');
                event.target.value = '';
            }
        });

        const form = document.getElementById('obituary-form');
        form.addEventListener('submit', function (e) {
            const name = document.getElementById('name').value;
            const birthDate = document.getElementById('birthDate').value;
            const deathDate = document.getElementById('deathDate').value;
            const alertBox = document.getElementById('form-alert');

            if (new Date(deathDate) < new Date(birthDate)) {
                e.preventDefault();
                alertBox.textContent = 'La fecha de fallecimiento no puede ser anterior a la de nacimiento.';
                alertBox.classList.remove('d-none');
                return false;
            }

            alertBox.classList.add('d-none');
        });
    </script>
    <script src="/js/obituary-data.js"></script>
{% endblock %}
